<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Home</title>
  <script type="module" src="data-service.js"></script>
</head>

<body>
  <button id="sign-in">Sign in</button>

  <button id="add-restaurant">Add restaurant</button>

  <script type="module">
    (async () => {
      const clientId = '93bc6d6286ff1f8d864c';
      const redirect_uri = encodeURIComponent('http://localhost:5500/client/oauth2-callback.html');
      const clientState = Math.random().toString();
      const scope = encodeURIComponent('repo');

      document.getElementById('sign-in').onclick = () => window.open(`https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${redirect_uri}&state=${clientState}&scope=${scope}`);

      const authorizationCode = await waitForAuthorizationCode({ clientState });
      console.dir(authorizationCode);

      const result = await fetch(`https://wt-9acbe4e672a011d1f00cc517028e7bb1-0.sandbox.auth0-extend.com/github-oauth2?code=${authorizationCode}`);
      const resultJson = await result.json();
      const accessToken = resultJson.access_token;

      console.dir(resultJson);

      localStorage.setItem('access_token', accessToken);
      sessionStorage.setItem('access_token', accessToken);
    })();

    async function waitForAuthorizationCode({ clientState }) {
      return new Promise((resolve, reject) => {
        let storageEventHandler; storageEventHandler;
        const storageKeyForAuthorizationCodeData = 'github_authorization_code_data';

        window.addEventListener('storage', storageEventHandler = event => {
          if (event.key === storageKeyForAuthorizationCodeData) {
            const { code, state } = JSON.parse(event.newValue);
            window.removeEventListener('storage', storageEventHandler);
            window.localStorage.removeItem(storageKeyForAuthorizationCodeData);
            if (state !== clientState) {
              reject('STATE_MISMATCH');
            } else {
              resolve(code);
            }
          }
        });
      });
    }
  </script>

  <script type="module" src="index.js"></script>
</body>

</html>